<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | ToyStore</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #FBEBB5;
            --soft-bg: #FAF4F4;
            --accent-blue: #7091E6;
            --menu-hover: #F9F1E7;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: #000;
            background-color: #fff;
        }


        /* --- NAVIGATION --- */
        .nav-link {
            font-weight: 600;
            color: #000 !important;
            margin: 0 15px;
        }

        .search-input-desktop {
            width: 0;
            opacity: 0;
            border: none;
            border-bottom: 2px solid #000;
            outline: none;
            transition: all 0.4s ease;
            padding: 0;
            background: transparent;
        }

        .search-input-desktop.active {
            width: 200px;
            opacity: 1;
            padding: 0 10px;
            margin-right: 10px;
        }

        .search-input-mobile {
            width: 100%;
            height: 0;
            opacity: 0;
            padding: 0;
            border: none;
            border-bottom: 2px solid #000;
            transition: all 0.3s ease;
            outline: none;
            overflow: hidden;
        }

        .search-input-mobile.active {
            height: 45px;
            opacity: 1;
            padding: 10px 0;
            margin-top: 15px;
        }

        /* --- HEADER BANNER --- */
        .page-header {
            background: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),
                url('https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?auto=format&fit=crop&q=80&w=1200');
            background-size: cover;
            background-position: center;
            padding: 70px 0;
            text-align: center;
        }

        .page-header h1 {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* --- MY ACCOUNT LAYOUT --- */
        .sidebar-menu {
            padding-right: 30px;
        }

        .menu-section-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .sidebar-link {
            display: block;
            padding: 10px 15px;
            color: #888;
            text-decoration: none;
            transition: 0.3s;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: var(--menu-hover);
            color: #B88E2F;
        }

        /* --- FORM STYLING --- */
        .profile-card {
            background: #fff;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .profile-card h3 {
            color: var(--gold-text);
            font-weight: 600;
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control-custom {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #D9D9D9;
            border-radius: 5px;
            margin-bottom: 20px;
            outline: none;
        }

        .btn-save {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 12px 35px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            transition: 0.3s;
        }

        .btn-save:hover {
            background-color: #5b79c7;
        }

        .btn-cancel {
            background: transparent;
            border: none;
            color: #000;
            margin-right: 20px;
        }

        /* --- FEATURES --- */
        .features {
            background: var(--soft-bg);
            padding: 80px 0;
            margin-top: 60px;
        }

        /* Custom Logout Styling */
        .logout-link {
            color: #dc3545 !important;
            /* Standard Bootstrap Red */
            transition: 0.3s ease;
        }

        .logout-link:hover {
            background-color: #fff5f5 !important;
            /* Very light red background */
            color: #a71d2a !important;
        }

        .sidebar-link i {
            font-size: 1.1rem;
            vertical-align: middle;
        }

        /* --- FOOTER --- */
        footer {
            background: #000;
            color: #fff;
            padding: 80px 0 20px;
        }

        footer a {
            color: #9F9F9F;
            display: block;
            margin-bottom: 12px;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .footer-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid #fff;
            color: #fff;
            width: 100%;
            padding-bottom: 5px;
            outline: none;
        }

        @media (max-width: 992px) {
            .sidebar-menu {
                margin-bottom: 40px;
            }

            .profile-card {
                padding: 20px;
            }
        }

        /* NAV ICONS */
        .navbar-logo {
            height: 40px;
        }

        .nav-icon {
            font-size: 1.4rem;
            color: #000;
            text-decoration: none;
        }

        .nav-search {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 30px;
            padding: 8px 16px;
            width: 260px;
        }

        .nav-search input {
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
        }

        @media (max-width: 991px) {
            .navbar-logo {
                height: 28px;
            }

            .nav-search {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-light bg-white py-3">
        <div class="container">

            <!-- TOP ROW -->
            <div class="d-flex align-items-center w-100">

                <!-- LOGO -->
                <a class="navbar-brand" href="index.html">
                    <img src="/Images/logo wings.png" class="navbar-logo" alt="Logo">
                </a>

                <!-- DESKTOP MENU (CENTER) -->
                <ul class="navbar-nav flex-row gap-4 mx-auto d-none d-lg-flex">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item signup-link">
                        <a class="nav-link" href="signup.html">Sign Up</a>
                    </li>

                </ul>

                <!-- DESKTOP RIGHT -->
                <div class="d-none d-lg-flex align-items-center gap-3">

                    <div class="nav-search">
                        <input type="text" placeholder="Search..." />
                        <i class="bi bi-search"></i>
                    </div>

                    <a href="wishlist.html" class="nav-icon auth-protected" data-target="wishlist.html">
                        <i class="bi bi-heart"></i>
                    </a>

                    <a href="cart.html" class="nav-icon auth-protected" data-target="cart.html">
                        <i class="bi bi-cart"></i>
                    </a>

                    <div id="auth-nav"></div>

                </div>

                <!-- MOBILE RIGHT -->
                <div class="d-flex align-items-center gap-3 d-lg-none ms-auto">
                    <a href="wishlist.html" class="nav-icon auth-protected" data-target="wishlist.html">
                        <i class="bi bi-heart"></i>
                    </a>

                    <a href="cart.html" class="nav-icon auth-protected" data-target="cart.html">
                        <i class="bi bi-cart"></i>
                    </a>

                    <div id="auth-nav-mobile"></div>

                    <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>

            </div>

            <!-- MOBILE SEARCH -->
            <div class="nav-search w-100 mt-3 d-lg-none">
                <input type="text" placeholder="Search..." />
                <i class="bi bi-search"></i>
            </div>

            <!-- MOBILE MENU -->
            <div class="collapse navbar-collapse d-lg-none mt-3" id="navbarNav">
                <ul class="navbar-nav gap-3">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item signup-link">
                        <a class="nav-link" href="signup.html">Sign Up</a>
                    </li>

                </ul>
            </div>

        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>Welcome, <span id="userName">User</span></h1>
            <p class="text-muted">Home <i class="bi bi-chevron-right mx-2"></i> My Account</p>
        </div>
    </header>

    <main class="container py-5">
        <div class="row">
            <div class="col-lg-3">
                <div class="sidebar-menu">
                    <p class="text-muted small">Account Details</p>

                    <div class="menu-section-title">Manage My Account</div>
                    <a href="#" class="sidebar-link active" id="myProfileLink">
                        My Profile
                    </a>

                    <a href="address-book.html" class="sidebar-link">Address Book</a>
                    <a href="MyPaymentOption.html" class="sidebar-link">My Payment Options</a>

                    <div class="menu-section-title">My Orders</div>
                    <a href="order.html" class="sidebar-link">
                        <i class="bi bi-bag-check me-2"></i> My Orders
                    </a>
                    <a href="MyReturns.html" class="sidebar-link">My Returns</a>
                    <a href="MyCancellations.html" class="sidebar-link">My Cancellations</a>

                    <div class="menu-section-title">My Wishlist</div>
                    <a href="wishlist.html" class="sidebar-link">My Wishlist</a>

                    <div class="menu-section-title mt-4">Account Actions</div>
                    <a href="#" id="logoutBtn" class="sidebar-link logout-link">
                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                    </a>

                </div>
            </div>


            <div class="col-lg-9">

                <!-- PROFILE SECTION -->
                <div id="profileSection">
                    <div class="profile-card">

                        <h4 class="mb-4 fw-bold" style="color: #000;">Edit Your Profile</h4>

                        <form>
                            <div class="row">
                                <div class="col-md-6 form-group">
                                    <label>First Name</label>
                                    <input type="text" id="firstName" class="form-control-custom">

                                </div>
                                <div class="col-md-6 form-group">
                                    <label>Last Name</label>
                                    <input type="text" id="lastName" class="form-control-custom">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 form-group">
                                    <label>Email</label>
                                    <input type="email" id="email" class="form-control-custom">

                                </div>

                            </div>

                            <h5 class="mt-4 mb-3 fw-bold">Change Password</h5>

                            <div class="form-group">
                                <input type="password" id="currentPassword" class="form-control-custom"
                                    placeholder="Current Password">
                                <input type="password" id="newPassword" class="form-control-custom"
                                    placeholder="New Password">
                                <input type="password" id="confirmPassword" class="form-control-custom"
                                    placeholder="Confirm New Password">
                            </div>
                            <button type="button" id="changePasswordBtn" class="btn-save mt-2">
                                Change Password
                            </button>

                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <button type="button" class="btn-cancel">Cancel</button>
                                <button type="submit" id="saveProfileBtn" class="btn-save"> Save Changes</button>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-9">

                <div id="profileSection">
                    ...
                </div>

                <!-- ORDERS SECTION -->
                <div id="ordersSection" class="d-none">
                    <h4 class="fw-bold mb-4">My Orders</h4>

                    <div id="ordersPage">
                        <div id="ordersContainer"></div>
                    </div>

                    <div id="orderDetailsPage" class="d-none">
                        <button class="btn btn-dark mb-3" onclick="showOrders()">‚Üê Back</button>
                        <div id="orderDetails"></div>
                    </div>
                </div>

            </div>



        </div>
    </main>

    <section class="features">
        <div class="container">
            <div class="row text-center text-md-start">
                <div class="col-md-4 mb-4">
                    <h3 class="fw-bold">Free Delivery</h3>
                    <p class="text-muted mb-0">For all orders over $50, consectetur adipim scing elit.</p>
                </div>
                <div class="col-md-4 mb-4">
                    <h3 class="fw-bold">90 Days Return</h3>
                    <p class="text-muted mb-0">If goods have problems, consectetur adipim scing elit.</p>
                </div>
                <div class="col-md-4">
                    <h3 class="fw-bold">Secure Payment</h3>
                    <p class="text-muted mb-0">100% secure payment, consectetur adipim scing elit.</p>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <p class="footer-address">400 University Drive Suite 200 Coral Gables, <br>FL 33134 USA</p>
                </div>
                <div class="col-lg-2 col-6 mb-4">
                    <span class="footer-title">Links</span>
                    <a href="index.html">Home</a>
                    <a href="shop.html">Shop</a>
                    <a href="about.html">About</a>
                    <a href="contact.html">Contact</a>
                </div>
                <div class="col-lg-2 col-6 mb-4">
                    <span class="footer-title">Help</span>
                    <a href="#">Payment Options</a>
                    <a href="#">Returns</a>
                    <a href="#">Privacy Policies</a>
                </div>
                <div class="col-lg-4 mb-4">
                    <span class="footer-title">Newsletter</span>
                    <div class="newsletter-form">
                        <input type="email" class="newsletter-input" placeholder="Enter Your Email Address">
                        <button class="newsletter-btn">SUBSCRIBE</button>
                    </div>
                </div>
            </div>
            <div class="copyright">
                2026 ToyStore. All rights reserved
            </div>
        </div>
    </footer>

    <!-- LOGIN REQUIRED MODAL -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">

                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Login Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">
                    <i class="bi bi-lock-fill fs-1 text-warning mb-3"></i>
                    <p class="mb-3">
                        You need to login to access your account.
                    </p>
                </div>

                <div class="modal-footer border-0 justify-content-center gap-3">
                    <a href="signup.html" class="btn btn-dark rounded-pill px-4">
                        Login / Sign Up
                    </a>
                    <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>

            </div>
        </div>
    </div>


    <script>

        document.addEventListener("DOMContentLoaded", async () => {
            let isLoggedIn = false;

            try {
                const res = await fetch("/api/check-auth", {
                    credentials: "include"
                });
                const data = await res.json();
                isLoggedIn = data.loggedIn === true;
            } catch {
                isLoggedIn = false;
            }

            // üîê Protect Cart / Wishlist / Account
            document.querySelectorAll(".auth-protected").forEach(link => {
                link.addEventListener("click", e => {
                    if (!isLoggedIn) {
                        e.preventDefault();
                        showLoginModal();
                    }
                });
            });

            // üë§ Account Icon Logic
            const desktop = document.getElementById("auth-nav");
            const mobile = document.getElementById("auth-nav-mobile");

            if (isLoggedIn) {
                const html = `
      <a href="my_account.html" class="nav-icon" title="My Account">
        <i class="bi bi-person-circle"></i>
      </a>
      <a href="order.html" class="nav-icon ms-2" title="My Orders">
        <i class="bi bi-bag-check"></i>
      </a>
    `;
                desktop.innerHTML = html;
                mobile.innerHTML = html;

                // ‚ùå REMOVE SIGNUP FROM NAV
                document.querySelectorAll(".signup-link").forEach(el => el.remove());
            } else {
                const html = `
      <a href="#" class="nav-icon login-required">
        <i class="bi bi-person"></i>
      </a>
    `;
                desktop.innerHTML = html;
                mobile.innerHTML = html;

                document.querySelectorAll(".login-required").forEach(el => {
                    el.addEventListener("click", e => {
                        e.preventDefault();
                        showLoginModal();
                    });
                });
            }
        });

        function showLoginModal() {
            const modal = new bootstrap.Modal(
                document.getElementById("loginRequiredModal")
            );
            modal.show();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ================= SEARCH ================= -->
    <script>
        document.getElementById('search-trigger').addEventListener('click', function (e) {
            e.preventDefault();
            if (window.innerWidth < 992) {
                const mobileInput = document.getElementById('search-input-mobile');
                mobileInput.classList.toggle('active');
                if (mobileInput.classList.contains('active')) mobileInput.focus();
            } else {
                const desktopInput = document.getElementById('search-desktop');
                desktopInput.classList.toggle('active');
                if (desktopInput.classList.contains('active')) desktopInput.focus();
            }
        });
    </script>

    <!-- ================= LOGOUT ================= -->
    <script>
        document.getElementById("logoutBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                await fetch("/api/logout", { method: "POST", credentials: "include" });
                localStorage.removeItem("userName");
                window.location.href = "index.html";
            } catch {
                alert("Logout failed. Please try again.");
            }
        });
    </script>

    <!-- ================= LOAD PROFILE ================= -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const res = await fetch("/api/users/me", { credentials: "include" });
                if (!res.ok) return window.location.href = "login.html";

                const { user } = await res.json();
                document.getElementById("userName").innerText = user.fullName || "User";

                const name = user.fullName?.split(" ") || [];
                document.getElementById("firstName").value = name[0] || "";
                document.getElementById("lastName").value = name.slice(1).join(" ") || "";
                document.getElementById("email").value = user.email || "";

                localStorage.setItem("userName", user.fullName);
            } catch (err) {
                console.error("Profile load failed", err);
            }
        });
    </script>

    <!-- ================= UPDATE PROFILE ================= -->
    <script>
        document.querySelector("form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const body = {
                firstName: firstName.value.trim(),
                lastName: lastName.value.trim(),
                email: email.value.trim()
            };

            try {
                const res = await fetch("/api/users/me", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (!res.ok) return alert(data.message || "Update failed");

                userName.innerText = data.user.fullName;
                localStorage.setItem("userName", data.user.fullName);
                alert("‚úÖ Profile updated successfully!");
            } catch {
                alert("Something went wrong. Try again.");
            }
        });
    </script>

    <!-- ================= CHANGE PASSWORD ================= -->
    <script>
        document.getElementById("changePasswordBtn").addEventListener("click", async () => {
            const currentPassword = currentPassword.value.trim();
            const newPassword = newPassword.value.trim();
            const confirmPassword = confirmPassword.value.trim();

            if (!currentPassword || !newPassword || !confirmPassword)
                return alert("Please fill all password fields");

            if (newPassword !== confirmPassword)
                return alert("Passwords do not match");

            try {
                const res = await fetch("/api/users/change-password", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
                });

                const data = await res.json();
                if (!res.ok) return alert(data.message);

                alert("üîê Password changed successfully");
                currentPassword.value = newPassword.value = confirmPassword.value = "";
            } catch {
                alert("Something went wrong. Try again.");
            }
        });
    </script>

    <!-- ================= ORDER.HTML FLOW ================= -->
    <script>
        let ALL_ORDERS = [];

        async function loadOrders() {
            const res = await fetch("/api/orders/my", { credentials: "include" });
            if (!res.ok) return window.location.href = "login.html";

            const data = await res.json();
            ALL_ORDERS = data.orders;

            const box = document.getElementById("ordersContainer");
            if (!ALL_ORDERS.length) return box.innerHTML = "<p>No orders found.</p>";

            box.innerHTML = ALL_ORDERS.map(o => `
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6>Order #${o._id.slice(-8).toUpperCase()}</h6>
            <small>${new Date(o.createdAt).toDateString()}</small>
          </div>
          <span class="badge bg-warning text-dark">${o.orderStatus}</span>
        </div>
        <hr>
        <div class="d-flex align-items-center">
          <img src="${o.items[0]?.product?.images?.[0] || 'https://via.placeholder.com/80'}"
               style="width:80px;height:80px;border-radius:10px" class="me-3">
          <div>
            <p class="fw-semibold mb-1">${o.items[0]?.product?.name}</p>
            <p>Qty: ${o.items[0]?.quantity}</p>
            <strong>‚Çπ${o.totalAmount}</strong>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" onclick="viewOrderDetails('${o._id}')">
            View Details
          </button>
        </div>
      </div>
    </div>
  `).join("");
        }

        function viewOrderDetails(id) {
            const o = ALL_ORDERS.find(x => x._id === id);
            if (!o) return;

            ordersPage.classList.add("d-none");
            orderDetailsPage.classList.remove("d-none");

            orderDetails.innerHTML = `
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3">Order #${o._id.slice(-8).toUpperCase()}</h5>
        ${o.items.map(i => `
          <div class="d-flex mb-3">
            <img src="${i.product?.images?.[0] || 'https://via.placeholder.com/80'}"
                 style="width:80px;height:80px;border-radius:10px" class="me-3">
            <div>
              <p class="fw-semibold mb-1">${i.product?.name}</p>
              <p>Qty: ${i.quantity}</p>
              <strong>‚Çπ${i.price}</strong>
            </div>
          </div>
        `).join("")}
        <hr>
        <h6 class="text-end">Total: ‚Çπ${o.totalAmount}</h6>
      </div>
    </div>
  `;
        }

        function showOrders() {
            orderDetailsPage.classList.add("d-none");
            ordersPage.classList.remove("d-none");
        }
    </script>

    <!-- ================= SIDEBAR TOGGLE ================= -->
    <script>
        const profileSection = document.getElementById("profileSection");
        const ordersSection = document.getElementById("ordersSection");
        const myOrdersLink = document.getElementById("myOrdersLink");
        const myProfileLink = document.getElementById("myProfileLink");

        myOrdersLink.onclick = e => {
            e.preventDefault();
            profileSection.classList.add("d-none");
            ordersSection.classList.remove("d-none");
            myOrdersLink.classList.add("active");
            myProfileLink.classList.remove("active");
            loadOrders();
        };

        myProfileLink.onclick = e => {
            e.preventDefault();
            ordersSection.classList.add("d-none");
            profileSection.classList.remove("d-none");
            myProfileLink.classList.add("active");
            myOrdersLink.classList.remove("active");
        };
    </script>


</body>

</html>