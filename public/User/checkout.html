<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Wings Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #6366f1; --bg-light: #f9fafb; --text-muted: #898989; }
        body { font-family: 'Poppins', sans-serif; background-color: #fff; color: #111; }

        /* --- Global Components --- */
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: #fff; }
        
        /* --- Hero Section --- */
        .hero-section {
            background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), 
                        url('https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?q=80&w=2043&auto=format&fit=crop');
            background-size: cover; background-position: center; padding: 100px 0; text-align: center;
        }

        /* --- Checkout Layout --- */
        .checkout-container { background-color: var(--bg-light); padding: 80px 0; }
        
        .payment-option {
            cursor: pointer; border: 2px solid #eee; border-radius: 15px; transition: 0.3s; 
            background: white; position: relative; padding: 25px; display: block;
        }
        .payment-input:checked + .payment-option { border-color: var(--primary-color); background-color: #f5f3ff; }
        .payment-input:checked + .payment-option::after {
            content: "\F272"; font-family: "bootstrap-icons"; position: absolute; top: 12px; right: 12px; color: var(--primary-color); font-size: 1.2rem;
        }

        /* --- Coupon Cards --- */
        .coupon-list-container { display: flex; overflow-x: auto; gap: 12px; padding: 10px 0; scrollbar-width: none; }
        .coupon-list-container::-webkit-scrollbar { display: none; }
        
        .coupon-card {
            min-width: 140px; background: white; border: 2px dashed #d1d5db;
            border-radius: 12px; padding: 12px; text-align: center; transition: 0.3s; cursor: pointer;
        }
        .coupon-card:hover, .coupon-card.active { border-color: var(--primary-color); background: #f5f3ff; transform: translateY(-3px); }
        .coupon-code { font-weight: 700; color: var(--primary-color); font-size: 0.9rem; }
        /* Upcoming coupon (fade + disable feel) */
.coupon-card.upcoming {
    opacity: 0.4;
    pointer-events: none;
    filter: grayscale(40%);
}

       
        /* --- Footer Black --- */
        .footer-black { background-color: #000; color: #fff; padding: 80px 0 30px; }
        .footer-black a { color: #fff; text-decoration: none; opacity: 0.7; transition: 0.3s; }
        .footer-black a:hover { opacity: 1; text-decoration: underline; }
        .newsletter-input { 
            background: transparent; border: none; border-bottom: 2px solid #fff; 
            color: #fff; width: 100%; padding: 8px 0; outline: none; 
        }
        .btn-subscribe { background: none; border: none; color: #fff; font-weight: 700; text-decoration: underline; }

        /* --- Modal Custom --- */
        .modal-content { border-radius: 25px; border: none; padding: 15px; }
        .form-control-custom { background: #f3f4f6; border: none; padding: 12px 18px; border-radius: 12px; margin-bottom: 15px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg py-4">
    <div class="container">
        <a class="navbar-brand fw-bold fs-3" href="#">WINGS</a>
        <div class="d-flex gap-4 fs-5 ms-auto">
            <i class="bi bi-person"></i><i class="bi bi-search"></i><i class="bi bi-heart"></i><i class="bi bi-cart3"></i>
        </div>
    </div>
</nav>

<section class="hero-section">
    <div class="container">
        <i class="bi bi-cart-check-fill fs-1 text-primary"></i>
        <h1 class="display-5 fw-bold mt-2">Checkout</h1>
        <p class="text-muted fw-medium">Home <i class="bi bi-chevron-right mx-2 small"></i> Checkout</p>
    </div>
</section>

<section class="checkout-container">
    <div class="container">
        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card card-custom p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold m-0"><i class="bi bi-geo-alt me-2"></i>Shipping Details</h5>
                        <button class="btn btn-outline-primary btn-sm fw-bold rounded-pill px-4"
  onclick="openAddressPopup()"
  data-bs-toggle="modal"
  data-bs-target="#addressPopup">
  Change Address
</button>


                    </div>
                    <div class="border rounded-4 p-4 d-flex align-items-center bg-white shadow-sm">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="bi bi-house-door-fill text-primary h4 mb-0"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold" id="displayUser">John Doe</p>
                            <small class="text-muted" id="displayAddr">123 Tech Avenue, Silicon Valley, CA 94043</small>
                        </div>
                    </div>
                </div>

                <div class="card card-custom p-4">
                    <h5 class="fw-bold mb-4"><i class="bi bi-credit-card me-2"></i>Payment Method</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="radio" name="p" id="pay-w" class="d-none payment-input" checked>
                            <label for="pay-w" class="payment-option text-center">
                                <i class="bi bi-wallet2 h2 mb-2 d-block"></i> <span class="fw-bold">Wallet</span>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <input type="radio" name="p" id="pay-u" class="d-none payment-input">
                            <label for="pay-u" class="payment-option text-center">
                                <i class="bi bi-qr-code h2 mb-2 d-block"></i> <span class="fw-bold">UPI</span>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <input type="radio" name="p" id="pay-c" class="d-none payment-input">
                            <label for="pay-c" class="payment-option text-center">
                                <i class="bi bi-truck h2 mb-2 d-block"></i> <span class="fw-bold">COD</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 sticky-top" style="top: 30px;">
                    <h5 class="fw-bold mb-4">Order Summary</h5>
                 <div id="checkoutItems"></div>

                    <div class="mb-4">
                        <label class="small fw-bold text-secondary mb-2">OFFERS FOR YOU</label>
                        <div class="coupon-list-container" id="couponContainer"></div>

                    </div>

                    <div class="d-flex justify-content-between mb-2"><span>Subtotal</span><span class="fw-bold" id="checkoutSubtotal">‚Çπ0</span></div>
                    <div class="d-flex justify-content-between mb-2 text-success"><span>Discount</span><span class="fw-bold" id="discAmount">-‚Çπ0.00</span></div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <span class="h5 fw-bold">Total</span><span class="fw-bold" id="grandTotal">‚Çπ0</span>

                    </div>

                    <button class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-lg border-0" onclick="finalCheck()">
                        Complete Order <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>



<footer class="footer-black">
    <div class="container">
        <div class="row g-5">
            <div class="col-md-4">
                <h3 class="fw-bold mb-4">WINGS.</h3>
                <p class="opacity-50">400 University Drive Suite 200 Coral Gables, FL 33134 USA</p>
            </div>
            <div class="col-md-2">
                <h6 class="text-secondary mb-4 text-uppercase small fw-bold">Links</h6>
                <p><a href="#">Home</a></p><p><a href="#">Shop</a></p><p><a href="#">About</a></p>
            </div>
            <div class="col-md-2">
                <h6 class="text-secondary mb-4 text-uppercase small fw-bold">Help</h6>
                <p><a href="#">Returns</a></p><p><a href="#">Privacy</a></p>
            </div>
            <div class="col-md-4">
                <h6 class="text-secondary mb-4 text-uppercase small fw-bold">Newsletter</h6>
                <div class="d-flex align-items-center">
                    <input type="text" class="newsletter-input" placeholder="Enter Email">
                    <button class="btn-subscribe ms-3">SUBSCRIBE</button>
                </div>
            </div>
        </div>
        <hr class="mt-5 mb-4 border-secondary opacity-25">
        <p class="m-0 opacity-50 small">¬© 2026 Meubel House. All rights reserved</p>
    </div>
</footer>

<div class="modal fade" id="addressPopup" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold">New Shipping Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
  <div id="addressList" class="d-flex flex-column gap-3">
    <!-- Saved addresses from My Account will be injected here -->
  </div>

  <div class="text-center mt-3">
    <a href="address-book.html" class="text-decoration-none fw-bold">
      + Add new address
    </a>
  </div>
</div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
 

    function saveAddress() {
        const name = document.getElementById('in-name').value;
        const street = document.getElementById('in-street').value;
        const city = document.getElementById('in-city').value;
        
        if(name && street) {
            document.getElementById('displayUser').innerText = name;
            document.getElementById('displayAddr').innerText = street + ", " + city;
            bootstrap.Modal.getInstance(document.getElementById('addressPopup')).hide();
        } else {
            alert("Please fill name and address");
        }
    }

    function finalCheck() {
        alert("‚ú® Order Placed Successfully! Redirecting to tracking...");
    }
</script>
<script>
let subtotal = 0;
let appliedDiscount = 0;
let appliedCoupon = null;

async function loadCheckoutCart() {
    try {
        const res = await fetch("/api/cart", {
            credentials: "include"
        });

        if (!res.ok) {
            alert("Please login to continue checkout");
            window.location.href = "/login.html";
            return;
        }

        const data = await res.json();
        const items = data.items || [];

        const container = document.getElementById("checkoutItems");
        container.innerHTML = "";
        subtotal = 0;

        if (items.length === 0) {
            container.innerHTML = `<p class="text-muted">Your cart is empty</p>`;
            updateTotals();
            return;
        }

        items.forEach(item => {
            const price = item.product.finalPrice;
            const qty = item.quantity;
            const itemTotal = price * qty;
            subtotal += itemTotal;

            container.innerHTML += `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <img src="${item.product.images[0]}" 
                         class="rounded-3 me-3" width="65">
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-bold">${item.product.name}</h6>
                        <small class="text-muted">Qty: ${qty}</small>
                    </div>
                    <span class="fw-bold">‚Çπ${itemTotal}</span>
                </div>
            `;
        });

        updateTotals();

    } catch (err) {
        console.error(err);
    }
}

function updateTotals() {
    document.getElementById("checkoutSubtotal").innerText = `‚Çπ${subtotal}`;
    document.getElementById("discAmount").innerText = `-‚Çπ${appliedDiscount}`;
    document.getElementById("grandTotal").innerText =
        `‚Çπ${subtotal - appliedDiscount}`;
}

document.addEventListener("DOMContentLoaded", loadCheckoutCart);
</script>

<script>
// 1Ô∏è‚É£ Load coupons from admin-created coupons
async function loadCoupons() {
    const res = await fetch("/api/coupons/checkout");

    const coupons = await res.json();

    const container = document.getElementById("couponContainer");
    container.innerHTML = "";

    const today = new Date();

    coupons.forEach(coupon => {
        const start = new Date(coupon.startDate);
        const end = new Date(coupon.expiryDate);

        // ‚ùå Hide expired coupons
        if (today > end) return;

        const div = document.createElement("div");
        div.className = "coupon-card";

        // üü° Upcoming ‚Üí fade
        if (today < start) {
            div.classList.add("upcoming");
        }

        div.innerHTML = `
            <span class="coupon-code">${coupon.code}</span><br>
            <small class="text-muted d-block">
                ${
                    coupon.discountType === "percentage"
                        ? `${coupon.discountValue}% OFF`
                        : coupon.discountType === "flat"
                        ? `‚Çπ${coupon.discountValue} OFF`
                        : "FREE SHIPPING"
                }
            </small>
            ${
                coupon.description
                    ? `<small class="text-secondary">${coupon.description}</small>`
                    : ""
            }
        `;

        // ‚úÖ Only active coupons clickable
        if (today >= start && today <= end) {
            div.onclick = () => applyCoupon(div, coupon);
        }

        container.appendChild(div);
    });
}



// 2Ô∏è‚É£ Apply coupon logic
function applyCoupon(element, coupon) {

    // üîí Safety: block upcoming coupons
    const today = new Date();
    if (today < new Date(coupon.startDate)) {
        alert("‚è≥ This coupon is not active yet");
        return;
    }

    if (subtotal < coupon.minCartValue) {
        alert(`Minimum cart value ‚Çπ${coupon.minCartValue} required`);
        return;
    }

    document.querySelectorAll(".coupon-card")
        .forEach(c => c.classList.remove("active"));
    element.classList.add("active");

    appliedDiscount = 0;

    if (coupon.discountType === "percentage") {
        appliedDiscount = Math.floor((subtotal * coupon.discountValue) / 100);
    }
    else if (coupon.discountType === "flat") {
        appliedDiscount = coupon.discountValue;
    }
    else if (coupon.discountType === "free_shipping") {
        appliedDiscount = 0;
        alert("üöö Free Shipping Applied!");
    }

    appliedCoupon = coupon.code;

    document.getElementById("discAmount").innerText =
        appliedDiscount > 0 ? `-‚Çπ${appliedDiscount}` : `‚Çπ0`;

    document.getElementById("grandTotal").innerText =
        `‚Çπ${(subtotal - appliedDiscount).toFixed(2)}`;
}


// 3Ô∏è‚É£ Place order (send coupon to backend)

async function finalCheck() {
  try {
    const paymentMethod = document.querySelector('input[name="p"]:checked')?.id;

    if (!paymentMethod) {
      Swal.fire({
        icon: "warning",
        title: "Select payment method",
        confirmButtonColor: "#6366f1"
      });
      return;
    }

    const res = await fetch("/api/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        subtotal,
        couponCode: appliedCoupon || null, // ‚úÖ optional coupon
        paymentMethod
      })
    });

    if (!res.ok) throw new Error("Order failed");

    // ‚úÖ SUCCESS
    Swal.fire({
      icon: "success",
      title: "Order Placed!",
      text: appliedCoupon
        ? `Coupon "${appliedCoupon}" applied successfully ‚ú®`
        : "Order placed without coupon",
      confirmButtonColor: "#6366f1",
      timer: 3000,
      timerProgressBar: true
    }).then(() => {
      window.location.href = "/orders.html";
    });

  } catch (err) {
    Swal.fire({
      icon: "error",
      title: "Order Failed",
      text: "Something went wrong. Please try again.",
      confirmButtonColor: "#ef4444"
    });
  }
}

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let savedAddresses = [];
let selectedAddress = null;

async function loadUserAddresses() {
  try {
    const res = await fetch("/api/users/me", {
      credentials: "include"
    });

    if (!res.ok) return;

    const data = await res.json();
    savedAddresses = data.user.addresses || [];

    if (savedAddresses.length === 0) return;

    // ‚úÖ pick default address
    selectedAddress =
      savedAddresses.find(a => a.isDefault) || savedAddresses[0];

    showAddress(selectedAddress);

  } catch (err) {
    console.error("Failed to load addresses", err);
  }
}

function showAddress(addr) {
  document.getElementById("displayUser").innerText =
    addr.name || "John Doe";

  document.getElementById("displayAddr").innerText =
    `${addr.addressLine}, ${addr.pincode}`;
}


document.addEventListener("DOMContentLoaded", loadUserAddresses);

function openAddressPopup() {
  const list = document.getElementById("addressList");
  list.innerHTML = "";

  savedAddresses.forEach(addr => {
    const div = document.createElement("div");
    div.className = "border rounded-4 p-3 cursor-pointer";

    div.innerHTML = `
      <strong>${addr.fullName}</strong><br>
      <small class="text-muted">
        ${addr.street}, ${addr.city} - ${addr.pincode}
      </small>
    `;

    div.onclick = () => {
      selectedAddress = addr;
      showAddress(addr);
      bootstrap.Modal.getInstance(
        document.getElementById("addressPopup")
      ).hide();
    };

    list.appendChild(div);
  });
}

</script>
</body>
</html>