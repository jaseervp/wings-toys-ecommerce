<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cancellations | ToyStore</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/navbar.css">

    <style>
        :root {
            --primary-bg: #FBEBB5;
            --soft-bg: #FAF4F4;
            --accent-blue: #7091E6;
            --menu-hover: #F9F1E7;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: #000;
            background-color: #fff;
        }

        /* --- NAVIGATION --- */
        .nav-link {
            font-weight: 600;
            color: #000 !important;
            margin: 0 15px;
        }

        /* --- HEADER BANNER --- */
        .page-header {
            background: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),
                url('https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?auto=format&fit=crop&q=80&w=1200');
            background-size: cover;
            background-position: center;
            padding: 70px 0;
            text-align: center;
        }

        .page-header h1 {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* --- SIDEBAR MENU --- */
        .sidebar-menu {
            padding-right: 30px;
        }

        .menu-section-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .sidebar-link {
            display: block;
            padding: 10px 15px;
            color: #888;
            text-decoration: none;
            transition: 0.3s;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: var(--menu-hover);
            color: #B88E2F;
        }

        /* --- CANCELLATIONS TABLE STYLES --- */
        .cancel-table thead th {
            background-color: #fcfcfc;
            border-bottom: 1px solid #eee;
            color: #000;
            font-weight: 600;
            padding: 15px;
            font-size: 0.9rem;
        }

        .cancel-table tbody td {
            padding: 20px 15px;
            vertical-align: middle;
            color: #444;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }

        .btn-view {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-view:hover {
            opacity: 0.7;
        }

        /* Custom Logout Styling */
        .logout-link {
            color: #dc3545 !important;
            /* Standard Bootstrap Red */
            transition: 0.3s ease;
        }

        .logout-link:hover {
            background-color: #fff5f5 !important;
            /* Very light red background */
            color: #a71d2a !important;
        }

        .sidebar-link i {
            font-size: 1.1rem;
            vertical-align: middle;
        }

        /* --- FEATURES & FOOTER --- */
        .features {
            background: var(--soft-bg);
            padding: 80px 0;
            margin-top: 60px;
        }

        footer {
            background: #000;
            color: #fff;
            padding: 80px 0 20px;
        }

        footer a {
            color: #9F9F9F;
            display: block;
            margin-bottom: 12px;
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* NAV ICONS */
        .navbar-logo {
            height: 40px;
        }

        .nav-icon {
            font-size: 1.4rem;
            color: #000;
            text-decoration: none;
        }

        .nav-search {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 30px;
            padding: 8px 16px;
            width: 260px;
        }

        .nav-search input {
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
        }

        @media (max-width: 991px) {
            .navbar-logo {
                height: 28px;
            }

            .nav-search {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-light bg-white py-3 navbar-fixed">
        <div class="container">

            <!-- TOP ROW -->
            <div class="d-flex align-items-center w-100">

                <!-- LOGO -->
                <a class="navbar-brand" href="index.html">
                    <img src="/Images/logo wings.png" class="navbar-logo" alt="Logo">
                </a>

                <!-- DESKTOP MENU (CENTER) -->
                <ul class="navbar-nav flex-row gap-4 mx-auto d-none d-lg-flex">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item signup-link">
                        <a class="nav-link" href="signup.html">Sign Up</a>
                    </li>

                </ul>

                <!-- DESKTOP RIGHT -->
                <div class="d-none d-lg-flex align-items-center gap-3">

                    <div class="nav-search">
                        <input type="text" placeholder="Search..." />
                        <i class="bi bi-search"></i>
                    </div>

                    <a href="wishlist.html" class="nav-icon auth-protected" data-target="wishlist.html">
                        <i class="bi bi-heart"></i>
                    </a>

                    <a href="cart.html" class="nav-icon auth-protected" data-target="cart.html">
                        <i class="bi bi-cart"></i>
                    </a>

                    <div id="auth-nav"></div>

                </div>

                <!-- MOBILE RIGHT -->
                <div class="d-flex align-items-center gap-3 d-lg-none ms-auto">
                    <a href="wishlist.html" class="nav-icon auth-protected" data-target="wishlist.html">
                        <i class="bi bi-heart"></i>
                    </a>

                    <a href="cart.html" class="nav-icon auth-protected" data-target="cart.html">
                        <i class="bi bi-cart"></i>
                    </a>

                    <div id="auth-nav-mobile"></div>

                    <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>

            </div>

            <!-- MOBILE SEARCH -->
            <div class="nav-search w-100 mt-3 d-lg-none">
                <input type="text" placeholder="Search..." />
                <i class="bi bi-search"></i>
            </div>

            <!-- MOBILE MENU -->
            <div class="collapse navbar-collapse d-lg-none mt-3" id="navbarNav">
                <ul class="navbar-nav gap-3">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item signup-link">
                        <a class="nav-link" href="signup.html">Sign Up</a>
                    </li>

                </ul>
            </div>

        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>My Cancellations</h1>
            <p class="text-muted">Home <i class="bi bi-chevron-right mx-2"></i> My Cancellations</p>
        </div>
    </header>

    <main class="container py-5">
        <div class="row">
            <div class="col-lg-3">
                <div class="sidebar-menu">
                    <p class="text-muted small">Account Details</p>

                    <div class="menu-section-title">Manage My Account</div>
                    <a href="my_account.html" class="sidebar-link ">
                        My Profile
                    </a>

                    <a href="address-book.html" class="sidebar-link">Address Book</a>
                    <a href="MyPaymentOption.html" class="sidebar-link">My Payment Options</a>

                    <div class="menu-section-title">My Orders</div>
                    <a href="order.html" class="sidebar-link">
                        <i class="bi bi-bag-check me-2"></i> My Orders
                    </a>
                    <a href="MyReturns.html" class="sidebar-link">My Returns</a>
                    <a href="MyCancellations.html" class="sidebar-link active">My Cancellations</a>

                    <div class="menu-section-title">My Wishlist</div>
                    <a href="wishlist.html" class="sidebar-link">My Wishlist</a>

                    <div class="menu-section-title mt-4">Account Actions</div>
                    <a href="#" id="logoutBtn" class="sidebar-link logout-link">
                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                    </a>

                </div>
            </div>

            <div class="col-lg-9">
                <h4 class="fw-bold mb-4">Cancelled Orders</h4>

                <div class="table-responsive">
                    <table class="table cancel-table">
                        <thead>
                            <tr>
                                <th class="border-0">Order ID</th>
                                <th class="border-0">Date Cancelled</th>
                                <th class="border-0">Refund Status</th>
                                <th class="border-0">Status</th>
                                <th class="border-0 text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    No cancelled orders found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <section class="features">
        <div class="container text-center text-md-start">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h3 class="fw-bold">Free Delivery</h3>
                    <p class="text-muted mb-0">For all orders over $50.</p>
                </div>
                <div class="col-md-4 mb-4 mb-md-0">
                    <h3 class="fw-bold">90 Days Return</h3>
                    <p class="text-muted mb-0">If goods have problems.</p>
                </div>
                <div class="col-md-4">
                    <h3 class="fw-bold">Secure Payment</h3>
                    <p class="text-muted mb-0">100% secure payment.</p>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <p class="footer-address">400 University Drive Suite 200 Coral Gables, <br>FL 33134 USA</p>
                </div>
                <div class="col-lg-2 col-6 mb-4">
                    <span class="footer-title">Links</span>
                    <a href="index.html">Home</a>
                    <a href="shop.html">Shop</a>
                    <a href="about.html">About</a>
                    <a href="contact.html">Contact</a>
                </div>
                <div class="col-lg-2 col-6 mb-4">
                    <span class="footer-title">Help</span>
                    <a href="#">Payment Options</a>
                    <a href="#">Returns</a>
                    <a href="#">Privacy Policies</a>
                </div>
                <div class="col-lg-4 mb-4">
                    <span class="footer-title">Newsletter</span>
                    <div class="newsletter-form">
                        <input type="email" class="newsletter-input" placeholder="Enter Your Email Address">
                        <button class="newsletter-btn">SUBSCRIBE</button>
                    </div>
                </div>
            </div>
            <div class="copyright">
                2026 ToyStore. All rights reserved
            </div>
        </div>
    </footer>

    <!-- LOGIN REQUIRED MODAL -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">

                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Login Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">
                    <i class="bi bi-lock-fill fs-1 text-warning mb-3"></i>
                    <p class="mb-3">
                        You need to login to access your account.
                    </p>
                </div>

                <div class="modal-footer border-0 justify-content-center gap-3">
                    <a href="signup.html" class="btn btn-dark rounded-pill px-4">
                        Login / Sign Up
                    </a>
                    <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>

            </div>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", fetchCancellations);

        async function fetchCancellations() {
            try {
                const res = await fetch("/api/orders/my?status=canceled", { credentials: "include" });
                if (!res.ok) return; // Auth logic handled by common script

                const data = await res.json();
                renderCancellations(data.orders);
            } catch (err) {
                console.error("Failed to load cancellations", err);
            }
        }

        function renderCancellations(orders) {
            const tbody = document.querySelector(".cancel-table tbody");

            if (!orders || orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No cancelled orders found.</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(order => {
                const canceledItems = order.items.filter(i => i.itemStatus === 'canceled');
                const isFullyCanceled = order.orderStatus === 'canceled';
                const canceledProductNames = canceledItems.map(i => i.product?.name || 'Unknown Product').join(', ');

                let refundBadge = '';
                if (order.paymentStatus === 'paid') {
                    if (order.isRefunded || isFullyCanceled) {
                        refundBadge = '<span class="badge bg-success text-white border border-success">Refunded</span>';
                    } else if (canceledItems.length > 0) {
                        refundBadge = '<span class="badge bg-info text-white border border-info">Item Refunded</span>';
                    } else {
                        refundBadge = '<span class="badge bg-warning text-dark border border-warning">Refund Pending</span>';
                    }
                } else {
                    refundBadge = '<span class="badge bg-secondary text-white border">No Refund (Unpaid)</span>';
                }

                return `
                <tr>
                    <td>
                        <div class="fw-bold">#${order._id.slice(-6).toUpperCase()}</div>
                        <div class="small text-muted text-truncate" style="max-width: 200px;">${canceledProductNames}</div>
                    </td>
                    <td>${new Date(order.updatedAt).toLocaleDateString()}</td>
                    <td>${refundBadge}</td>
                    <td>
                        <span class="status-badge status-cancelled">
                            ${isFullyCanceled ? 'Full Cancellation' : 'Partial Cancellation'}
                        </span>
                    </td>
                    <td class="text-end">
                        <a href="order.html?id=${order._id}" class="btn-view">View Details</a>
                    </td>
                </tr>
            `}).join("");
        }
    </script>


    <script>

        document.addEventListener("DOMContentLoaded", async () => {
            let isLoggedIn = false;

            try {
                const res = await fetch("/api/check-auth", {
                    credentials: "include"
                });
                const data = await res.json();
                isLoggedIn = data.loggedIn === true;
            } catch {
                isLoggedIn = false;
            }

            // ðŸ” Protect Cart / Wishlist / Account
            document.querySelectorAll(".auth-protected").forEach(link => {
                link.addEventListener("click", e => {
                    if (!isLoggedIn) {
                        e.preventDefault();
                        showLoginModal();
                    }
                });
            });

            // ðŸ‘¤ Account Icon Logic
            const desktop = document.getElementById("auth-nav");
            const mobile = document.getElementById("auth-nav-mobile");

            if (isLoggedIn) {
                const html = `
      <a href="my_account.html" class="nav-icon" title="My Account">
        <i class="bi bi-person-circle"></i>
      </a>
      <a href="order.html" class="nav-icon ms-2" title="My Orders">
        <i class="bi bi-bag-check"></i>
      </a>
    `;
                desktop.innerHTML = html;
                mobile.innerHTML = html;

                // âŒ REMOVE SIGNUP FROM NAV
                document.querySelectorAll(".signup-link").forEach(el => el.remove());
            } else {
                const html = `
      <a href="#" class="nav-icon login-required">
        <i class="bi bi-person"></i>
      </a>
    `;
                desktop.innerHTML = html;
                mobile.innerHTML = html;

                document.querySelectorAll(".login-required").forEach(el => {
                    el.addEventListener("click", e => {
                        e.preventDefault();
                        showLoginModal();
                    });
                });
            }
        });

        function showLoginModal() {
            const modal = new bootstrap.Modal(
                document.getElementById("loginRequiredModal")
            );
            modal.show();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>