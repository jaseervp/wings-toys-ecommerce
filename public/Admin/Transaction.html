<!DOCTYPE html>
<html lang="en" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wings Admin | Transaction</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 260px;
            --main-bg: #F8F9FD;
            --sidebar-bg: #ffffff;
            --accent-blue: #6C8EEF;
            --text-dark: #2D3748;
            --text-gray: #A0AEC0;
            --card-border: #EDF2F7;
            --table-header: #F1F6FF;
            --card-bg: #ffffff;
            --success-green: #48BB78;
            --danger-red: #F56565;
            --warning-orange: #ED8936;
        }

        [data-theme="dark"] {
            --sidebar-bg: #1A202C;
            --main-bg: #11141D;
            --card-bg: #1A202C;
            --text-dark: #E2E8F0;
            --text-gray: #718096;
            --card-border: #2D3748;
            --table-header: #212936;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--main-bg);
            margin: 0;
            display: flex;
            color: var(--text-dark);
            transition: background 0.3s;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            z-index: 1050;
            transition: transform 0.3s ease;
        }

        .sidebar-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-brand img {
            height: 45px;
            margin-bottom: 25px;
        }

        .menu-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: capitalize;
            margin: 20px 0 10px 10px;
            font-weight: 500;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-gray);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .nav-item.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item:hover:not(.active) {
            background: rgba(108, 142, 239, 0.1);
            color: var(--accent-blue);
        }

        .admin-footer {
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: var(--sidebar-bg);
        }

        .admin-profile-box {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
        }

        .admin-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .admin-email {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        /* --- MAIN WRAPPER --- */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 30px;
            transition: margin 0.3s, width 0.3s;
        }

        /* --- SUMMARY CARDS --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }

        .summary-card .dots {
            position: absolute;
            top: 15px;
            right: 15px;
            color: var(--text-gray);
            cursor: pointer;
        }

        .summary-title {
            font-size: 0.9rem;
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: 10px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .trend-up {
            color: var(--success-green);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .trend-down {
            color: var(--danger-red);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* --- SEARCH BAR --- */
        .custom-search-group {
            background: #F4F7FE;
            border-radius: 12px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            padding: 6px 15px;
            transition: 0.2s;
        }

        .custom-search-group:focus-within {
            border-color: var(--accent-blue);
            background: #fff;
        }

        .custom-search-group input {
            background: transparent;
            border: none;
            box-shadow: none;
            font-size: 0.85rem;
            padding-left: 10px;
            width: 100%;
        }

        .custom-search-group input:focus {
            outline: none;
        }

        /* --- TABLE --- */
        .content-card {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--card-border);
            padding: 25px;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 850px;
        }

        .custom-table thead tr {
            background: var(--table-header);
        }

        .custom-table th {
            padding: 15px;
            font-size: 0.85rem;
            border: none;
            font-weight: 500;
            color: var(--text-gray);
        }

        .custom-table td {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
            vertical-align: middle;
            font-size: 0.85rem;
        }

        /* Status Badges */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-complete {
            color: var(--success-green);
            font-weight: 500;
        }

        .status-canceled {
            color: var(--danger-red);
            font-weight: 500;
        }

        .status-pending {
            color: var(--warning-orange);
            font-weight: 500;
        }

        .action-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        /* --- MOBILE OVERLAY --- */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1040;
        }

        /* --- RESPONSIVE QUERIES --- */
        .mobile-nav-btn {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-dark);
        }

        @media (max-width: 992px) {
            .mobile-nav-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .top-bar {
                justify-content: space-between;
            }

            .custom-search-group.d-none {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .table-filters {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .table-filters .d-flex {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-scroll">
            <div class="sidebar-brand"><img src="logo wings.png" alt="Wings"></div>
            <p class="menu-label">Main menu</p>
            <a href="Dashboard.html" class="nav-item"><i class="bi bi-grid"></i> Dashboard</a>
            <a href="OrderMangement.html" class="nav-item"><i class="bi bi-cart"></i> Order Management</a>
            <a href="Customers.html" class="nav-item"><i class="bi bi-people"></i> Customers</a>
            <a href="Cuopon.html" class="nav-item"><i class="bi bi-ticket-perforated"></i> Coupon Code</a>
            <a href="Categories.html" class="nav-item"><i class="bi bi-tags"></i> Categories</a>
            <a href="Transaction.html" class="nav-item active"><i class="bi bi-arrow-left-right"></i> Transaction</a>
            <a href="Offers.html" class="nav-item "><i class="bi bi-megaphone"></i> Offers & Ads</a>

            <p class="menu-label">Product</p>
            <a href="AddProduct.html" class="nav-item"><i class="bi bi-plus-circle"></i> Add Products</a>

            <a href="ProductList.html" class="nav-item"><i class="bi bi-list-ul"></i> Product List</a>
            <a href="ProductReviews.html" class="nav-item"><i class="bi bi-chat-left-text"></i> Product Reviews</a>
        </div>

        <div class="admin-footer">
            <p class="menu-label" style="margin-left:0; margin-top:0">Admin</p>
            <a href="AdminRole.html" class="nav-item p-0 mb-3"><i class="bi bi-person-gear"></i> Admin role</a>
            <div class="admin-profile-box">
                <img src="profile-pic.png" class="admin-avatar" alt="Admin">
                <div class="admin-info">
                    <p class="admin-name">Dealport</p>
                    <p class="admin-email">Mark@thedesigner...</p>
                </div>
                <i class="bi bi-box-arrow-right text-gray" style="cursor: pointer; margin-left: auto;"></i>
            </div>
            <a href="#" class="nav-item p-0" style="color: var(--accent-blue); font-weight: 600;">
                <i class="bi bi-shop"></i> Your Shop <i class="bi bi-box-arrow-up-right ms-auto small"></i>
            </a>
        </div>
    </aside>

    <main class="main-wrapper">
        <div class="top-bar d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-list mobile-nav-btn" onclick="toggleSidebar()"></i>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="theme-toggle" onclick="toggleTheme()"
                    style="cursor: pointer; width: 40px; height: 40px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--card-border); display: flex; align-items: center; justify-content: center; color: var(--text-gray);">
                    <i class="bi bi-moon-stars-fill" id="tIcon"></i>
                </div>
                <img src="profile-pic.png" class="rounded-circle border admin-avatar" width="38" height="38"
                    style="object-fit: cover;">
            </div>
        </div>

        <!-- Summary Cards (Dynamic) -->
        <div class="summary-grid mb-4">
            <div class="summary-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="summary-title text-muted">Total Credited</div>
                        <div class="summary-value text-success" id="totalCreditDisplay">₹0.00</div>
                    </div>
                    <div class="p-2 rounded-circle bg-success bg-opacity-10 text-success">
                        <i class="bi bi-arrow-down-left-circle fs-4"></i>
                    </div>
                </div>
            </div>
            <div class="summary-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="summary-title text-muted">Total Debited</div>
                        <div class="summary-value text-danger" id="totalDebitDisplay">₹0.00</div>
                    </div>
                    <div class="p-2 rounded-circle bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-arrow-up-right-circle fs-4"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card border-0 shadow-sm" style="border-radius: 12px; min-height: 80vh;">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <h5 class="fw-bold mb-0">Transaction List</h5>

                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <!-- Date Filter -->
                    <select id="dateFilter" class="form-select bg-white border shadow-sm text-secondary"
                        style="width: auto; font-size: 0.9rem; border-radius: 8px;">
                        <option value="all_time">Date: All Time</option>
                        <option value="today">Today</option>
                        <option value="last_7_days">Last 7 Days</option>
                        <option value="last_1_month">Last 1 Month</option>
                    </select>

                    <!-- Type Filter -->
                    <select id="typeFilter" class="form-select bg-white border shadow-sm text-secondary"
                        style="width: auto; font-size: 0.9rem; border-radius: 8px;">
                        <option value="all">Type: All</option>
                        <option value="credit">Credit</option>
                        <option value="debit">Debit</option>
                    </select>

                    <button class="btn btn-white bg-white border shadow-sm text-dark fw-medium px-3"
                        style="border-radius: 8px; font-size: 0.9rem;">
                        <i class="bi bi-box-arrow-up-right me-2"></i> Export
                    </button>

                    <div class="position-relative">
                        <input type="text" id="searchInput" class="form-control border shadow-sm"
                            placeholder="Search ID, Name..."
                            style="padding-right: 30px; border-radius: 8px; font-size: 0.9rem; width: 220px;">
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" style="border-collapse: separate; border-spacing: 0;">
                    <thead class="bg-white">
                        <tr>
                            <th class="border-0 text-secondary fw-bold small py-3 ps-3">Trx ID</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Date</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Customer</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Item</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Method</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Type</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Amount</th>
                            <th class="border-0 text-secondary fw-bold small py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList" class="border-top-0">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-end align-items-center mt-4" id="paginationControls">
                <!-- Populated by JS -->
            </div>
        </div>
    </main>

    <!-- Transaction Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <div class="modal-header border-0 pb-0 px-4 pt-4">
                    <h5 class="modal-title fw-bold">Transaction Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body px-4 pt-2 pb-4">
                    <!-- Hero Section -->
                    <div class="text-center p-4 mb-4"
                        style="background-color: #F8FAFC; border-radius: 12px; margin-top: 10px;">
                        <h2 class="fw-bold mb-1" id="receiptAmount" style="color: #10B981; font-size: 2rem;">+ ₹0.00
                        </h2>
                        <span class="text-uppercase fw-bold" id="receiptStatus"
                            style="font-size: 0.75rem; letter-spacing: 1px;">SUCCESS</span>
                    </div>

                    <!-- Details List -->
                    <div class="d-flex flex-column gap-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Transaction ID</span>
                            <span class="fw-medium text-dark text-break ps-3 text-end" id="receiptId">TRX-000000</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Date</span>
                            <span class="fw-medium text-dark text-end" id="receiptDate">01-01-2025</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Customer</span>
                            <span class="fw-medium text-dark text-end" id="receiptCustomer">John Doe</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Item / Details</span>
                            <span class="fw-bold text-dark text-end ps-4" id="receiptItem">Item Name (x1)</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Payment Method</span>
                            <span class="fw-medium text-dark text-end" id="receiptMethod">Online</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Type</span>
                            <span class="fw-medium text-dark text-end" id="receiptType">Credit</span>
                        </div>
                    </div>

                    <!-- Footer Buttons -->
                    <div class="d-flex gap-3 mt-4 pt-2">
                        <button type="button" class="btn btn-light flex-grow-1 fw-medium" data-bs-dismiss="modal"
                            style="padding: 10px; border-radius: 8px; color: #4B5563;">Close</button>
                        <button type="button" class="btn btn-primary flex-grow-1 fw-medium" onclick="window.print()"
                            style="padding: 10px; border-radius: 8px; background-color: #3B82F6; border-color: #3B82F6;">
                            <i class="bi bi-download me-2"></i> Download PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function toggleTheme() {
            const html = document.getElementById('html-root');
            const icon = document.getElementById('tIcon');
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                icon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
            } else {
                html.setAttribute('data-theme', 'dark');
                icon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
    </script>
    <script>
        // Init logic for Sidebar/Theme is above in static script
    </script>
    <script>
        let currentPage = 1;
        let allTransactions = []; // Store for modal

        async function fetchTransactions() {
            const token = localStorage.getItem('adminToken');
            const dateFilter = document.getElementById('dateFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const search = document.getElementById('searchInput').value;

            const query = `?page=${currentPage}&limit=10&filter=${dateFilter}&type=${typeFilter}&search=${search}`;

            try {
                const res = await fetch(`/api/admin/transactions${query}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                const data = await res.json();
                allTransactions = data.transactions;

                // Update Totals
                document.getElementById('totalCreditDisplay').textContent = `₹${(data.totalCredit || 0).toLocaleString('en-IN')}`;
                document.getElementById('totalDebitDisplay').textContent = `₹${(data.totalDebit || 0).toLocaleString('en-IN')}`;

                renderTable(data.transactions);
                renderPagination(data.currentPage, data.totalPages);
            } catch (err) {
                console.error("Error loading transactions:", err);
            }
        }

        function renderTable(transactions) {
            const tbody = document.getElementById('transactionList');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No transactions found</td></tr>';
                return;
            }
            tbody.innerHTML = transactions.map((t, index) => {
                const isCredit = t.type === 'Credit';
                const statusColor = t.status === 'Success' ? '#10B981' :
                    t.status === 'Refunded' ? '#EF4444' : '#10B981';
                const statusBg = t.status === 'Success' ? '#D1FAE5' :
                    t.status === 'Refunded' ? '#FEE2E2' : '#D1FAE5';

                // If status is specific like Pending or Failed, adjust colors
                let realStatusBg = statusBg;
                let realStatusColor = statusColor;
                if (t.status === 'Pending') { realStatusBg = '#FEF3C7'; realStatusColor = '#F59E0B'; }
                if (t.status === 'Failed') { realStatusBg = '#FEE2E2'; realStatusColor = '#EF4444'; }

                const methodIcon = t.method === 'wallet' ? 'bi-wallet2' : 'bi-globe';
                const methodText = t.method === 'wallet' ? 'Wallet' : 'Online';

                // Format amount with symbol
                const amountText = `₹${t.amount.toLocaleString('en-IN')}.00`;

                // Trx ID Link color
                const idColor = t.type === 'Debit' ? '#EF4444' : '#4F46E5';

                // Vertical Bar Color
                const barColor = t.status === 'Refunded' ? '#EF4444' : '#10B981';

                return `
                    <tr style="cursor: pointer;" onclick="showReceipt(${index})">
                        <td class="ps-3 py-3" style="border-left: 5px solid ${barColor};">
                            <a href="#" class="text-decoration-none fw-medium" style="color: ${idColor}; margin-left:8px;">${t.trxId}</a>
                        </td>
                        <td class="py-3">
                            <div class="d-flex flex-column">
                                <span class="fw-medium text-dark" style="font-size: 0.9rem;">${new Date(t.date).toLocaleDateString('en-GB')}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">${new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                            </div>
                        </td>
                        <td class="py-3">
                            <span class="fw-medium text-dark" style="font-size: 0.9rem;">${t.customer?.fullName || 'Unknown'}</span>
                        </td>
                        <td class="py-3">
                            <span class="text-dark d-block text-truncate" style="max-width: 250px; font-size: 0.9rem;">${t.items || '-'}</span>
                        </td>
                        <td class="py-3">
                            <div class="d-flex align-items-center text-secondary" style="font-size: 0.9rem;">
                                <i class="bi ${methodIcon} me-2"></i> ${methodText}
                            </div>
                        </td>
                        <td class="py-3">
                            <span class="fw-medium" style="font-size: 0.9rem; color: #374151;">${t.type}</span>
                        </td>
                        <td class="py-3">
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">${amountText}</span>
                        </td>
                        <td class="py-3">
                            <span class="badge rounded-pill border-0" style="background:${realStatusBg}; color:${realStatusColor}; font-weight: 600; font-size: 0.75rem; padding: 6px 12px;">
                                ${t.status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showReceipt(index) {
            const t = allTransactions[index];
            if (!t) return;

            // Populate Fields
            document.getElementById('receiptId').textContent = t.trxId;
            document.getElementById('receiptDate').textContent = new Date(t.date).toLocaleString('en-GB');
            document.getElementById('receiptCustomer').textContent = t.customer?.fullName || 'Unknown';
            document.getElementById('receiptItem').textContent = t.items || 'Unknown Order';
            document.getElementById('receiptMethod').textContent = t.method === 'wallet' ? 'Wallet' : 'Online';
            document.getElementById('receiptType').textContent = t.type;

            // Amount styling
            const elAmount = document.getElementById('receiptAmount');
            const elStatus = document.getElementById('receiptStatus');

            elAmount.textContent = (t.type === 'Credit' ? '+ ' : '- ') + `₹${t.amount.toLocaleString('en-IN')}.00`;
            elStatus.textContent = t.status.toUpperCase();

            if (t.type === 'Debit' || t.status === 'Refunded' || t.status === 'Failed') {
                elAmount.style.color = '#EF4444'; // Red
            } else {
                elAmount.style.color = '#10B981'; // Green
            }

            // Show Modal
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            modal.show();
        }

        function renderPagination(current, total) {
            const container = document.getElementById('paginationControls');
            if (total <= 1) { container.innerHTML = ''; return; }

            let pagesHtml = '';
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - 1 && i <= current + 1)) {
                    pagesHtml += `<button onclick="changePage(${i})" class="btn btn-sm ${i === current ? 'btn-primary' : 'btn-light'} mx-1" style="min-width: 32px;">${i}</button>`;
                } else if (i === current - 2 || i === current + 2) {
                    pagesHtml += `<span class="mx-1 text-muted">...</span>`;
                }
            }

            container.innerHTML = `
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item ${current === 1 ? 'disabled' : ''}">
                            <button class="page-link border-0 text-secondary" onclick="changePage(${current - 1})">Previous</button>
                        </li>
                        ${pagesHtml}
                        <li class="page-item ${current === total ? 'disabled' : ''}">
                            <button class="page-link border-0 text-secondary" onclick="changePage(${current + 1})">Next</button>
                        </li>
                    </ul>
                </nav>
            `;
        }

        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            fetchTransactions();
        }

        // Listeners
        document.getElementById('dateFilter').addEventListener('change', () => { currentPage = 1; fetchTransactions(); });
        document.getElementById('typeFilter').addEventListener('change', () => { currentPage = 1; fetchTransactions(); });
        document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; fetchTransactions(); });

        // Init
        fetchTransactions();

        (async function updateAdminProfileUI() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;
            try {
                const res = await fetch('/api/admin/profile', { headers: { Authorization: 'Bearer ' + token } });
                if (!res.ok) return;
                const admin = await res.json();
                if (admin.avatar) document.querySelectorAll('.admin-avatar').forEach(img => img.src = admin.avatar);
                if (admin.fullName) document.querySelectorAll('.admin-name').forEach(el => el.textContent = admin.fullName);
            } catch (err) { console.error('Failed to load admin profile:', err); }
        })();

        // Export PDF Function
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Fetch ALL data for export (using high limit)
            const token = localStorage.getItem('adminToken');
            const dateFilter = document.getElementById('dateFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const search = document.getElementById('searchInput').value;

            // Use limit=10000 to get "all"
            const query = `?page=1&limit=10000&filter=${dateFilter}&type=${typeFilter}&search=${search}`;

            try {
                const res = await fetch(`/api/admin/transactions${query}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                const data = await res.json();
                const transactions = data.transactions;

                if (!transactions || transactions.length === 0) {
                    alert("No transactions to export");
                    return;
                }

                // Table Columns
                const columns = ["Trx ID", "Date", "Customer", "Item", "Method", "Type", "Amount", "Status"];

                // Table Rows
                const rows = transactions.map(t => [
                    t.trxId,
                    new Date(t.date).toLocaleDateString('en-GB'),
                    t.customer?.fullName || 'Unknown',
                    t.items,
                    t.method,
                    t.type,
                    `Rs. ${t.amount}`,
                    t.status
                ]);

                // Header
                doc.setFontSize(18);
                doc.text("Transaction Report", 14, 22);
                doc.setFontSize(11);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);
                doc.text(`Filter: ${dateFilter.replace('_', ' ')} | Type: ${typeFilter}`, 14, 36);

                // AutoTable
                doc.autoTable({
                    head: [columns],
                    body: rows,
                    startY: 44,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [108, 142, 239] } // Accent Blue
                });

                doc.save('Transaction_Report.pdf');

            } catch (err) {
                console.error("Export failed:", err);
                alert("Failed to export PDF");
            }
        }

        // Bind Export Button
        document.querySelector('.btn-white').addEventListener('click', exportPDF);

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="js/admin-global.js"></script>
</body>

</html>