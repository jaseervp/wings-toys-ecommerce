<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wings Admin | Offers & Promotions</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg: #ffffff;
            --main-bg: #F8F9FD;
            --card-bg: #ffffff;
            --text-dark: #2D3748;
            --text-gray: #A0AEC0;
            --accent-blue: #6C8EEF;
            --card-border: #EDF2F7;
            --trend-up: #4FD1C5;
            --offer-orange: #FF805D;
        }

        [data-theme="dark"] {
            --sidebar-bg: #1A202C;
            --main-bg: #11141D;
            --card-bg: #1A202C;
            --text-dark: #E2E8F0;
            --text-gray: #718096;
            --card-border: #2D3748;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-dark);
            margin: 0;
            display: flex;
            transition: all 0.3s ease;
        }

        /* --- SIDEBAR (Left Side) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            z-index: 1050;
            transition: transform 0.3s ease;
        }

        .sidebar-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-brand img {
            height: 45px;
            margin-bottom: 25px;
        }


        /* Sidebar Bottom (Admin Section) */
        .admin-footer {
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: var(--sidebar-bg);
        }

        .admin-profile-box {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
        }

        .admin-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .admin-email {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin: 0;
        }

        .menu-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: capitalize;
            margin: 20px 0 10px 10px;
            font-weight: 500;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-gray);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .nav-item.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item:hover:not(.active) {
            background: rgba(108, 142, 239, 0.1);
            color: var(--accent-blue);
        }

        /* --- MAIN WRAPPER --- */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 30px;
            min-height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
        }

        /* --- OFFER SPECIFIC STYLES --- */
        .offer-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-control,
        .form-select {
            background: var(--main-bg);
            border: 1px solid var(--card-border);
            color: var(--text-dark);
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .btn-primary-custom {
            background: var(--accent-blue);
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 500;
            color: #fff;
        }

        /* --- TABLE STYLE --- */
        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
            vertical-align: middle;
            color: var(--text-dark);
        }

        .table thead {
            background: var(--main-bg);
        }

        .table th {
            border: none;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-gray);
            padding: 15px 20px;
        }

        .table td {
            border-top: 1px solid var(--card-border);
            padding: 15px 20px;
            font-size: 0.85rem;
        }

        .badge-active {
            background: rgba(79, 209, 197, 0.1);
            color: var(--trend-up);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
        }

        .badge-expired {
            background: rgba(255, 128, 93, 0.1);
            color: var(--offer-orange);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
        }

        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: 0.3s;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-wrapper {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }

            .mobile-toggle {
                display: block !important;
            }
        }

        .mobile-toggle {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>

<body data-theme="light">

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-scroll">
            <div class="sidebar-brand"><img src="logo wings.png" alt="Wings"></div>
            <p class="menu-label">Main menu</p>
            <a href="Dashbord.html" class="nav-item "><i class="bi bi-grid"></i> Dashboard</a>
            <a href="OrderMangement.html" class="nav-item"><i class="bi bi-cart"></i> Order Management</a>
            <a href="Customers.html" class="nav-item"><i class="bi bi-people"></i> Customers</a>
            <a href="Cuopon.html" class="nav-item"><i class="bi bi-ticket-perforated"></i> Coupon Code</a>
            <a href="Categories.html" class="nav-item"><i class="bi bi-tags"></i> Categories</a>
            <a href="Transaction.html" class="nav-item"><i class="bi bi-arrow-left-right"></i> Transaction</a>
            <a href="Offers.html" class="nav-item active"><i class="bi bi-megaphone"></i> Offers & Ads</a>


            <p class="menu-label">Product</p>
            <a href="AddProduct.html" class="nav-item"><i class="bi bi-plus-circle"></i> Add Products</a>

            <a href="ProductList.html" class="nav-item"><i class="bi bi-list-ul"></i> Product List</a>
            <a href="ProductReviews.html" class="nav-item"><i class="bi bi-chat-left-text"></i> Product Reviews</a>
        </div>

        <div class="admin-footer">
            <p class="menu-label" style="margin-left:0; margin-top:0">Admin</p>
            <a href="AdminRole.html" class="nav-item p-0 mb-3"><i class="bi bi-person-gear"></i> Admin role</a>
            <div class="admin-profile-box">
                <img src="profile-pic.png" class="admin-avatar" alt="Admin">
                <div class="admin-info">
                    <p class="admin-name">Dealport</p>
                    <p class="admin-email">Mark@thedesigner...</p>
                </div>
                <i class="bi bi-box-arrow-right text-gray" style="cursor: pointer;"></i>
            </div>
            <a href="#" class="nav-item p-0" style="color: var(--accent-blue); font-weight: 600;">
                <i class="bi bi-shop"></i> Your Shop <i class="bi bi-box-arrow-up-right ms-auto small"></i>
            </a>
        </div>
    </aside>

    <main class="main-wrapper">
        <div class="top-bar">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-list mobile-toggle"
                    onclick="document.getElementById('sidebar').classList.toggle('active')"></i>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="theme-toggle" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="tIcon"></i></div>
                <img src="profile-pic.png" class="rounded-circle border" width="38" height="38">
            </div>
        </div>

        <!-- Main Card Container -->
        <div class="card border-0 shadow-sm p-4" style="border-radius: 12px;">

            <!-- Header Row inside Card -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="m-0 fw-bold">Active Offers</h4>

                <div class="d-flex gap-3">
                    <div class="search-box bg-white border rounded ps-2"
                        style="max-width: 300px; display: flex; align-items: center;">
                        <i class="bi bi-search text-secondary me-2"></i>
                        <input type="text" placeholder="Search offer name..." class="border-0 bg-transparent py-2"
                            style="outline: none; width: 200px;">
                    </div>
                    <button class="btn btn-primary px-4 fw-medium" data-bs-toggle="modal"
                        data-bs-target="#newSaleModal">
                        <i class="bi bi-plus-lg me-2"></i>New Offer
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="bg-light">
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th class="ps-4 py-3 text-secondary fw-medium">Banner</th>
                            <th class="py-3 text-secondary fw-medium">Offer Name</th>
                            <th class="py-3 text-secondary fw-medium">Offer</th>
                            <th class="py-3 text-secondary fw-medium">Target</th>
                            <th class="py-3 text-secondary fw-medium">Start Date</th>
                            <th class="py-3 text-secondary fw-medium">End Date</th>
                            <th class="py-3 text-secondary fw-medium">Status</th>
                            <th class="text-end pe-4 py-3 text-secondary fw-medium">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="ps-4 py-3">
                                <img src="https://via.placeholder.com/80x30" alt="Banner"
                                    style="height: 35px; width: 80px; object-fit: cover; border-radius: 6px;">
                            </td>
                            <td class="fw-bold text-dark">Arg spcl</td>
                            <td class="text-primary fw-bold">Min ₹20</td>
                            <td class="text-dark">Team</td>
                            <td class="text-secondary">22/12/2025</td>
                            <td class="text-secondary">26/02/2026</td>
                            <td><span
                                    class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-medium">Active</span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm"
                                    style="background: #FFF8E1; color: #FFA000; border-radius: 8px; width: 32px; height: 32px;"><i
                                        class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm ms-1"
                                    style="background: #FFEBEE; color: #EF5350; border-radius: 8px; width: 32px; height: 32px;"><i
                                        class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                        <tr>
                            <td class="ps-4 py-3">
                                <img src="https://via.placeholder.com/80x30" alt="Banner"
                                    style="height: 35px; width: 80px; object-fit: cover; border-radius: 6px;">
                            </td>
                            <td class="fw-bold text-dark">blckfriday</td>
                            <td class="text-primary fw-bold">Min 2%</td>
                            <td class="text-dark">Category</td>
                            <td class="text-secondary">23/12/2025</td>
                            <td class="text-secondary">02/01/2026</td>
                            <td><span
                                    class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill fw-medium">Expired/Inactive</span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm"
                                    style="background: #FFF8E1; color: #FFA000; border-radius: 8px; width: 32px; height: 32px;"><i
                                        class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm ms-1"
                                    style="background: #FFEBEE; color: #EF5350; border-radius: 8px; width: 32px; height: 32px;"><i
                                        class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- New Sale Modal -->
        <div class="modal fade" id="newSaleModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
                    <div class="modal-header border-bottom-0 pb-0">
                        <h5 class="modal-title fw-bold">Create Offer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-3 px-4">
                        <form>
                            <!-- OFFER INFO -->
                            <div class="mb-4">
                                <h6 class="text-uppercase fw-bold mb-3"
                                    style="color: #4F46E5; font-size: 0.75rem; letter-spacing: 0.5px;">Offer Info</h6>

                                <div class="mb-3">
                                    <label class="form-label fw-medium">Offer Name <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control bg-light border-0"
                                        placeholder="e.g. Monsoon Mega Sale" style="height: 45px;">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-medium">Banner Image <span
                                            class="text-danger">*</span></label>

                                    <!-- Unified Upload & Preview Area -->
                                    <div id="uploadArea"
                                        class="d-flex flex-column align-items-center justify-content-center border-2 border-dashed rounded-3 bg-light position-relative overflow-hidden"
                                        style="border-style: dashed; border-color: #cbd5e1; height: 160px; cursor: pointer;">

                                        <!-- File Input -->
                                        <input type="file" id="offerImageInput"
                                            class="position-absolute w-100 h-100 opacity-0" accept="image/*"
                                            style="cursor: pointer; z-index: 10;">

                                        <!-- Placeholder Content -->
                                        <div id="uploadPlaceholder" class="text-center pointer-events-none">
                                            <i class="bi bi-card-image fs-1 text-secondary mb-2"></i>
                                            <div class="text-secondary small">Click to upload (Rec: 1200x600)</div>
                                        </div>

                                        <!-- Preview Image -->
                                        <img id="finalPreview" src="" class="position-absolute w-100 h-100 d-none"
                                            style="object-fit: cover; z-index: 5;">

                                        <!-- Remove Button -->
                                        <button type="button" id="removeImage"
                                            class="btn btn-light shadow-sm position-absolute top-0 end-0 m-2 rounded-circle p-0 d-none align-items-center justify-content-center"
                                            style="width: 28px; height: 28px; z-index: 20;">
                                            <i class="bi bi-x fs-5 text-danger"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- DISCOUNT RULES -->
                            <div class="mb-4">
                                <h6 class="text-uppercase fw-bold mb-3"
                                    style="color: #4F46E5; font-size: 0.75rem; letter-spacing: 0.5px;">Discount Rules
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-medium">Offer Type</label>
                                        <select class="form-select bg-light border-0" style="height: 45px;">
                                            <option>Flat Discount</option>
                                            <option>Percentage Discount</option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label fw-medium">Value <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control bg-light border-0"
                                            placeholder="e.g. 50 or 500" style="height: 45px;">
                                    </div>
                                </div>
                            </div>

                            <!-- TARGETING -->
                            <div class="mb-4">
                                <h6 class="text-uppercase fw-bold mb-3"
                                    style="color: #4F46E5; font-size: 0.75rem; letter-spacing: 0.5px;">Targeting</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-medium">Applies To</label>
                                    <select class="form-select bg-light border-0" id="offerTarget"
                                        style="height: 45px;">
                                        <option value="all">All Products</option>
                                        <option value="category">Specific Category</option>
                                        <option value="product">Specific Product</option>
                                    </select>
                                </div>

                                <!-- Dynamic Product Selection -->
                                <div id="productSelectionContainer" class="p-3 border rounded bg-white mt-3"
                                    style="display: none;">
                                    <label class="form-label fw-medium small text-muted mb-2">Select Products</label>
                                    <input type="text" id="productSearch" class="form-control form-control-sm mb-2"
                                        placeholder="Search products...">
                                    <div id="productList"
                                        style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 5px;">
                                        <!-- Products will be loaded here -->
                                        <div class="text-center text-muted small py-2">Loading products...</div>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <small class="text-muted" id="selectedCount">0 selected</small>
                                    </div>
                                </div>
                            </div>

                            <!-- SCHEDULE -->
                            <div class="mb-4">
                                <h6 class="text-uppercase fw-bold mb-3"
                                    style="color: #4F46E5; font-size: 0.75rem; letter-spacing: 0.5px;">Schedule</h6>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-medium">Start Date <span
                                                class="text-danger">*</span></label>
                                        <input type="date" class="form-control bg-light border-0" style="height: 45px;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-medium">End Date <span
                                                class="text-danger">*</span></label>
                                        <input type="date" class="form-control bg-light border-0" style="height: 45px;">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium">Status</label>
                                    <select class="form-select bg-light border-0" style="height: 45px;">
                                        <option>Active</option>
                                        <option>Inactive</option>
                                        <option>Scheduled</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top-0 px-4 pb-4">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary px-4 py-2"
                            style="background-color: #4F46E5; border-color: #4F46E5;">Save Offer</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Crop Modal -->
        <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Crop Banner (2:1 Ratio)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0" style="height: 500px; background: #333;">
                        <img id="cropImage" src="" style="max-width: 100%; display: block;">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="cropBtn"
                            style="background-color: #4F46E5;">Crop & Save</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function toggleTheme() {
            const b = document.body; const i = document.getElementById('tIcon');
            const isDark = b.getAttribute('data-theme') === 'dark';
            b.setAttribute('data-theme', isDark ? 'light' : 'dark');
            i.classList.toggle('bi-moon-stars-fill'); i.classList.toggle('bi-sun-fill');
        }
    </script>
    <script>
        (async function updateAdminProfileUI() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;

            try {
                const res = await fetch('/api/admin/profile', {
                    headers: { Authorization: 'Bearer ' + token }
                });

                if (!res.ok) return;

                const admin = await res.json();

                // Update Sidebar & Topbar Images
                if (admin.avatar) {
                    document.querySelectorAll('.admin-avatar, .rounded-circle.border').forEach(img => {
                        img.src = admin.avatar;
                    });
                }

                // Update Name & Email
                if (admin.fullName) {
                    document.querySelectorAll('.admin-name').forEach(el => el.textContent = admin.fullName);
                }
                if (admin.email) {
                    document.querySelectorAll('.admin-email').forEach(el => el.textContent = admin.email);
                }

            } catch (err) {
                console.error('Failed to load admin profile:', err);
            }
        })();
    </script>
    <script src="js/admin-global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const offerTarget = document.getElementById('offerTarget');
            const productSelectionContainer = document.getElementById('productSelectionContainer');
            const productList = document.getElementById('productList');
            const productSearch = document.getElementById('productSearch');
            const selectedCount = document.getElementById('selectedCount');
            const selectionLabel = document.getElementById('selectionLabel');

            let loadedProducts = [];
            let loadedCategories = [];

            // Listen for Target Selection Change
            offerTarget.addEventListener('change', async function () {
                const type = this.value;

                if (type === 'product' || type === 'category') {
                    productSelectionContainer.style.display = 'block';

                    // Update UI Label & Placeholder
                    const searchInput = document.getElementById('productSearch');
                    const label = productSelectionContainer.querySelector('label');

                    if (type === 'product') {
                        label.textContent = 'Select Products';
                        searchInput.placeholder = 'Search products...';
                        if (loadedProducts.length === 0) await fetchProducts();
                        else renderProducts(loadedProducts);
                    } else {
                        label.textContent = 'Select Category';
                        searchInput.placeholder = 'Search categories...';
                        if (loadedCategories.length === 0) await fetchCategories();
                        else renderCategories(loadedCategories);
                    }
                    updateCount(); // Reset count for new view

                } else {
                    productSelectionContainer.style.display = 'none';
                }
            });

            // Fetch Products from API
            async function fetchProducts() {
                const token = localStorage.getItem('adminToken');
                try {
                    const res = await fetch('/api/admin/products', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (!res.ok) throw new Error('Failed to fetch products');

                    loadedProducts = await res.json();
                    renderProducts(loadedProducts);

                } catch (err) {
                    console.error(err);
                    productList.innerHTML = `<div class="text-danger small p-2">Error loading products</div>`;
                }
            }

            // Fetch Categories from API (NEW)
            async function fetchCategories() {
                const token = localStorage.getItem('adminToken');
                try {
                    const res = await fetch('/api/categories', { // Assuming public or admin route
                        // Check route. Usually /api/categories is public. 
                        // Let's check adminRoutes or categoryRoutes if needed.
                        // Public /api/categories is fine.
                    });

                    if (!res.ok) throw new Error('Failed to fetch categories');

                    loadedCategories = await res.json();
                    renderCategories(loadedCategories);

                } catch (err) {
                    console.error(err);
                    productList.innerHTML = `<div class="text-danger small p-2">Error loading categories</div>`;
                }
            }

            // Render Products List
            function renderProducts(products) {
                if (products.length === 0) {
                    productList.innerHTML = `<div class="text-muted small p-2 text-center">No products found</div>`;
                    return;
                }

                productList.innerHTML = products.map(p => `
                    <div class="d-flex align-items-center border-bottom py-2 px-3 hover-bg pointer-events-auto" onclick="document.getElementById('prod_${p._id}').click()">
                        <input class="form-check-input product-checkbox m-0 me-3" type="checkbox" value="${p._id}" id="prod_${p._id}" onclick="event.stopPropagation()">
                        <div class="flex-grow-1 d-flex justify-content-between align-items-center small">
                            <span class="fw-medium text-truncate" style="max-width: 250px;">${p.name}</span>
                            <span class="badge bg-light text-dark border">₹${p.finalPrice}</span>
                        </div>
                    </div>
                `).join('');

                // Attach checkbox listeners to update count
                document.querySelectorAll('.product-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateCount);
                });
            }

            // Render Categories List (NEW)
            function renderCategories(categories) {
                if (categories.length === 0) {
                    productList.innerHTML = `<div class="text-muted small p-2 text-center">No categories found</div>`;
                    return;
                }

                productList.innerHTML = categories.map(c => `
                    <div class="d-flex align-items-center border-bottom py-2 px-3 hover-bg pointer-events-auto" onclick="document.getElementById('cat_${c._id}').click()">
                        <input class="form-check-input product-checkbox m-0 me-3" type="checkbox" value="${c._id}" id="cat_${c._id}" onclick="event.stopPropagation()">
                        <div class="flex-grow-1 d-flex justify-content-between align-items-center small">
                            <span class="fw-medium text-truncate" style="max-width: 250px;">${c.name}</span>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">Category</span>
                        </div>
                    </div>
                `).join('');

                // Re-attach listeners (using same class 'product-checkbox' is fine for generic selector, or reuse updateCount)
                document.querySelectorAll('.product-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateCount);
                });
            }

            // Filter Products/Categories on Search
            productSearch.addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const type = offerTarget.value;

                if (type === 'product') {
                    const filtered = loadedProducts.filter(p =>
                        p.name.toLowerCase().includes(term) ||
                        (p.sku && p.sku.toLowerCase().includes(term))
                    );
                    renderProducts(filtered);
                } else if (type === 'category') {
                    const filtered = loadedCategories.filter(c =>
                        c.name.toLowerCase().includes(term)
                    );
                    renderCategories(filtered);
                }
            });

            // Update Selected Count
            function updateCount() {
                const count = document.querySelectorAll('.product-checkbox:checked').length;
                selectedCount.textContent = `${count} selected`;
            }

            // --- FETCH OFFERS LOGIC ---
            async function fetchOffers() {
                const token = localStorage.getItem('adminToken');
                const tbody = document.querySelector('tbody');

                try {
                    const res = await fetch('/api/admin/offers', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (!res.ok) throw new Error('Failed to fetch offers');

                    const offers = await res.json();

                    if (offers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No offers found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = offers.map(offer => {
                        const startDate = new Date(offer.startDate).toLocaleDateString('en-GB');
                        const endDate = new Date(offer.endDate).toLocaleDateString('en-GB');

                        // Status Logic
                        const now = new Date();
                        const start = new Date(offer.startDate);
                        const end = new Date(offer.endDate);
                        let statusBadges = '';

                        if (!offer.isActive) {
                            statusBadges = '<span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill fw-medium">Inactive</span>';
                        } else if (now > end) {
                            statusBadges = '<span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill fw-medium">Expired</span>';
                        } else if (now < start) {
                            statusBadges = '<span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill fw-medium">Upcoming</span>';
                        } else {
                            statusBadges = '<span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-medium">Active</span>';
                        }

                        // Offer Value Display
                        const offerValue = offer.discountType === 'percentage' ? `${offer.discountValue}% Off` : `Flat ₹${offer.discountValue}`;

                        // Target Display Logic (Static Label)
                        let targetDisplay = 'All Products';
                        if (offer.targetType === 'product') targetDisplay = 'Specific Product';
                        else if (offer.targetType === 'category') targetDisplay = 'Specific Category';

                        return `
                        <tr>
                            <td class="ps-4 py-3">
                                <img src="${offer.bannerImage}" alt="Banner" style="height: 35px; width: 80px; object-fit: cover; border-radius: 6px;">
                            </td>
                            <td class="fw-bold text-dark">${offer.name}</td>
                            <td class="text-primary fw-bold">${offerValue}</td>
                            <td class="fw-medium text-dark">${targetDisplay}</td>
                            <td class="text-secondary">${startDate}</td>
                            <td class="text-secondary">${endDate}</td>
                            <td>${statusBadges}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm" onclick="editOffer('${offer._id}')" style="background: #FFF8E1; color: #FFA000; border-radius: 8px; width: 32px; height: 32px;"><i class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm ms-1" onclick="deleteOffer('${offer._id}')" style="background: #FFEBEE; color: #EF5350; border-radius: 8px; width: 32px; height: 32px;"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                        `;
                    }).join('');

                } catch (err) {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger">Error loading offers</td></tr>';
                }
            }

            // Initial Load
            fetchOffers();

            // --- GLOBAL HELPERS (Attached to Window for onClick) ---

            // DELETE OFFER with SweetAlert2
            window.deleteOffer = async (id) => {
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (!result.isConfirmed) return;

                try {
                    const token = localStorage.getItem('adminToken');
                    const res = await fetch(`/api/admin/offers/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (res.ok) {
                        Swal.fire('Deleted!', 'Offer has been deleted.', 'success');
                        fetchOffers();
                    } else {
                        Swal.fire('Error', 'Failed to delete offer', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'Error deleting offer', 'error');
                }
            };

            // EDIT OFFER
            let isEditMode = false;
            let currentOfferId = null;

            window.editOffer = async (id) => {
                try {
                    const token = localStorage.getItem('adminToken');
                    const res = await fetch(`/api/admin/offers/${id}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (!res.ok) throw new Error('Failed to fetch offer details');
                    const offer = await res.json();

                    // 1. Populate Modal Fields
                    const form = document.querySelector('#newSaleModal form');
                    form.querySelector('input[placeholder="e.g. Monsoon Mega Sale"]').value = offer.name;

                    const selects = form.querySelectorAll('select');
                    const inputs = form.querySelectorAll('input');

                    // Discount Type
                    selects[0].value = offer.discountType === 'percentage' ? 'Percentage Discount' : 'Flat Discount';

                    // Discount Value
                    inputs[2].value = offer.discountValue;

                    // Targeting
                    const targetSelect = document.getElementById('offerTarget');
                    targetSelect.value = offer.targetType;

                    // Manually trigger fetch and wait
                    const productSelectionContainer = document.getElementById('productSelectionContainer');
                    const searchInput = document.getElementById('productSearch');
                    const label = productSelectionContainer.querySelector('label');

                    if (offer.targetType === 'product' || offer.targetType === 'category') {
                        productSelectionContainer.style.display = 'block';

                        // Set UI Labels
                        if (offer.targetType === 'product') {
                            label.textContent = 'Select Products';
                            searchInput.placeholder = 'Search products...';
                            if (loadedProducts.length === 0) await fetchProducts();
                            else renderProducts(loadedProducts);
                        } else {
                            label.textContent = 'Select Category';
                            searchInput.placeholder = 'Search categories...';
                            if (loadedCategories.length === 0) await fetchCategories();
                            else renderCategories(loadedCategories);
                        }

                        // Select the Target Checkbox
                        if (offer.targetId) {
                            // Find checkbox by ID (prod_ID or cat_ID)
                            // Note: My render functions use prod_${id} and cat_${id}
                            const prefix = offer.targetType === 'product' ? 'prod_' : 'cat_';
                            const checkbox = document.getElementById(`${prefix}${offer.targetId}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                updateCount();

                                // Scroll to it
                                checkbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    } else {
                        productSelectionContainer.style.display = 'none';
                    }

                    // Dates
                    const dateInputs = form.querySelectorAll('input[type="date"]');
                    dateInputs[0].value = new Date(offer.startDate).toISOString().split('T')[0];
                    dateInputs[1].value = new Date(offer.endDate).toISOString().split('T')[0];

                    // Status
                    selects[2].value = offer.isActive ? 'Active' : 'Inactive';

                    // Image Handling
                    finalPreview.src = offer.bannerImage;
                    document.getElementById('uploadPlaceholder').classList.add('d-none');
                    finalPreview.classList.remove('d-none');
                    removeImageBtn.classList.remove('d-none');
                    removeImageBtn.classList.add('d-flex');

                    // Set Edit Mode State
                    isEditMode = true;
                    currentOfferId = offer._id;

                    // Update Modal Title & Button
                    document.querySelector('.modal-title').textContent = 'Edit Offer';
                    document.querySelector('.modal-footer .btn-primary').textContent = 'Update Offer';

                    // Show Modal
                    const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
                    modal.show();

                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'Failed to load offer details', 'error');
                }
            };

            // Reset Modal on Close
            document.getElementById('newSaleModal').addEventListener('hidden.bs.modal', () => {
                document.querySelector('#newSaleModal form').reset();
                isEditMode = false;
                currentOfferId = null;
                document.querySelector('.modal-title').textContent = 'Create Offer';
                document.querySelector('.modal-footer .btn-primary').textContent = 'Save Offer';
                document.getElementById('productSelectionContainer').style.display = 'none'; // Hide container
                document.getElementById('selectedCount').textContent = '0 selected'; // Reset count

                // Reset Image UI
                removeImageBtn.click(); // Reuse remove logic
            });

            // --- CROPPER VARIABLES & LOGIC ---
            let cropper;
            let croppedBlob = null;

            // Elements
            const imageInput = document.getElementById('offerImageInput');
            const uploadArea = document.getElementById('uploadArea');
            // const finalPreviewContainer = document.getElementById('finalPreviewContainer'); // Removed
            const finalPreview = document.getElementById('finalPreview');
            const removeImageBtn = document.getElementById('removeImage');

            // Modal Elements
            const cropModalEl = document.getElementById('cropModal');
            const cropModal = new bootstrap.Modal(cropModalEl);
            const cropImage = document.getElementById('cropImage');
            const cropBtn = document.getElementById('cropBtn');

            // 1. File Selection -> Show Modal
            imageInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        cropImage.src = e.target.result;
                        cropModal.show();
                    };
                    reader.readAsDataURL(file);
                }
                this.value = '';
            });

            // 2. Initialize Cropper when Modal opens
            cropModalEl.addEventListener('shown.bs.modal', () => {
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropImage, {
                    aspectRatio: 2 / 1,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    background: false
                });
            });

            // 3. Destroy Cropper when Modal closes
            cropModalEl.addEventListener('hidden.bs.modal', () => {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });

            // 4. Crop & Save
            cropBtn.addEventListener('click', () => {
                if (!cropper) return;

                cropper.getCroppedCanvas({
                    width: 800,
                    height: 400
                }).toBlob((blob) => {
                    croppedBlob = blob;
                    finalPreview.src = URL.createObjectURL(blob);

                    // UI: Show Preview, Hide Placeholder
                    document.getElementById('uploadPlaceholder').classList.add('d-none');
                    finalPreview.classList.remove('d-none');

                    // Show Remove Button
                    removeImageBtn.classList.remove('d-none');
                    removeImageBtn.classList.add('d-flex');

                    cropModal.hide();
                }, 'image/jpeg');
            });

            // 5. Remove Image
            removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Stop click from triggering file input

                finalPreview.src = '';
                croppedBlob = null;
                imageInput.value = '';

                // UI: Hide Preview, Show Placeholder
                document.getElementById('uploadPlaceholder').classList.remove('d-none');
                finalPreview.classList.add('d-none');

                // Hide Remove Button
                removeImageBtn.classList.add('d-none');
                removeImageBtn.classList.remove('d-flex');
            });

            // --- SAVE / UPDATE OFFER LOGIC ---
            // Name Validation (Frontend)
            const nameInput = document.querySelector('input[placeholder="e.g. Monsoon Mega Sale"]');
            nameInput.addEventListener('input', function () {
                // Allow only letters and single spaces (No numbers)
                let val = this.value;
                val = val.replace(/[^a-zA-Z ]/g, ''); // Remove special chars AND numbers
                val = val.replace(/\s+/g, ' '); // Replace multiple spaces with single space
                this.value = val;
            });

            // Discount Value Validation (No Negatives)
            const discountInput = document.querySelector('input[placeholder="e.g. 50 or 500"]');
            discountInput.addEventListener('input', function () {
                let val = this.value;
                // Remove any non-digit/dot (effectively prevents '-')
                val = val.replace(/[^0-9.]/g, '');

                // Prevent multiple dots
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                this.value = val;
            });

            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            saveBtn.addEventListener('click', async () => {
                const form = document.querySelector('#newSaleModal form');

                // Selectors (re-verified)
                const name = form.querySelector('input[placeholder="e.g. Monsoon Mega Sale"]').value.trim();
                const discountType = form.querySelectorAll('select')[0].value === 'Percentage Discount' ? 'percentage' : 'flat';
                const discountValue = form.querySelector('input[placeholder="e.g. 50 or 500"]').value;
                const targetType = document.getElementById('offerTarget').value;
                const dateInputs = form.querySelectorAll('input[type="date"]');
                const startDate = dateInputs[0].value;
                const endDate = dateInputs[1].value;
                const isActive = form.querySelectorAll('select')[2].value === 'Active';

                // Validation
                const hasImage = croppedBlob || (isEditMode && finalPreview.getAttribute('src') && finalPreview.getAttribute('src') !== '');

                if (!name || !discountValue || !startDate || !endDate || !hasImage) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Fields',
                        text: 'Please fill all required fields and upload/crop an image.'
                    });
                    return;
                }

                if (name.length < 3) {
                    Swal.fire('Invalid Name', 'Offer Name must be at least 3 characters long', 'warning');
                    return;
                }

                // Date Validation
                if (new Date(startDate) > new Date(endDate)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Date',
                        text: 'End Date cannot be before Start Date'
                    });
                    return;
                }

                // Prepare Data
                const formData = new FormData();
                formData.append('name', name);
                formData.append('discountType', discountType);
                formData.append('discountValue', discountValue);
                formData.append('targetType', targetType);
                formData.append('startDate', startDate);
                formData.append('endDate', endDate);
                formData.append('isActive', isActive);

                if (croppedBlob) {
                    formData.append('bannerImage', croppedBlob, 'banner.jpg');
                }

                // Target ID logic
                if (targetType === 'product' || targetType === 'category') {
                    const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        Swal.fire('Warning', `Please select a ${targetType}`, 'warning');
                        return;
                    }
                    // Backend expects single targetId currently
                    formData.append('targetId', selectedCheckboxes[0].value);
                }

                try {
                    const token = localStorage.getItem('adminToken');
                    let url = '/api/admin/offers';
                    let method = 'POST';

                    if (isEditMode && currentOfferId) {
                        url = `/api/admin/offers/${currentOfferId}`;
                        method = 'PUT';
                    }

                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Authorization': 'Bearer ' + token },
                        body: formData
                    });

                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Failed to save offer');

                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: isEditMode ? 'Offer updated successfully' : 'Offer created successfully',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    location.reload();

                } catch (err) {
                    console.error(err);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: err.message
                    });
                }
            });
        });
    </script>
    <style>
        .hover-bg:hover {
            background-color: #f8f9fa;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</body>

</html>